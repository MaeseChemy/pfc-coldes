<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" 
	applicationComplete="init()" themeColor="#009DFF" 
	xmlns:flexlib="http://code.google.com/p/flexlib/"
	xmlns:lang="es.uc3m.coldes.utils.lang.*">

	<mx:Script>
		<![CDATA[
			import mx.managers.PopUpManager;
			import es.uc3m.coldes.view.user.UserDataForm;
			import flexlib.events.SuperTabEvent;
			import flexlib.controls.tabBarClasses.SuperTab;
			import es.uc3m.coldes.utils.popup.UtilPopUp;
			import es.uc3m.coldes.entities.User;
			import es.uc3m.coldes.business.UserService;
			import es.uc3m.coldes.utils.lang.ResourceLanguage;
			import mx.validators.Validator;
			import mx.controls.Alert;
			
			/*************************************/
			/**            VARIABLES            **/
			/*************************************/
			[Bindable]
			private var _lang:String;
			
			public function set lang(lang:String):void{
				_lang = lang;
			}
			
			public function get lang():String{
				return _lang;
			}
			
			[Bindable]
			private var _userLoged:User;
			
			public function set userLoged(user:User):void{
				_userLoged = user;
			}
			
			public function get userLoged():User{
				return _userLoged;
			}
			
			/*************************************/
			/**         INIT FUNCTIONS          **/
			/*************************************/
			private function init():void{
				ResourceLanguage.setResources(resourceManager);
				this.changeLocale("en_US");
				this.changeLocale("es_ES");
				
				primaryVS.selectedChild=loginFacade;
				tabs.setClosePolicyForTab(0, SuperTab.CLOSE_NEVER);
			}
			
			private function changeLocale(locale:String):void{
				resourceManager.localeChain=[locale];
				lang = locale;
			}
			
			/*************************************/
			/**   FUNCIONES DE ACCESO A COLDES  **/
			/*************************************/
			private function doLogin():void {
				var errors:Array=Validator.validateAll(validators);
				if (errors.length==0) {
					(new UserService()).doLogin(txtUser.text, txtPassword.text, loginCallback);
				}
			}
			private function loginCallback(user:User):void{
				if (user!=null) {
					signedIn(user);
				}else {
					UtilPopUp.showMessagePopUP(resourceManager.getString('myResources','ERRORTITLE.LOGIN'),
											   resourceManager.getString('myResources','ERROR.LOGIN'));
				}
			}
			private function signedIn(user:User):void {
				txtUser.text="";
				txtPassword.text="";
				//Set user
				userLoged = user;
				labelUsername.text=userLoged.username;
			    if(userLoged.admin){
			    	labelUsername.text+='(ADM)';
			    	menuAdmin.includeInLayout=true;
			    	menuAdmin.visible=true;
			    }
				primaryVS.selectedChild=mainWindow;
			}
			
			private function doLogout():void {
				var errors:Array=Validator.validateAll(validators);
				if (errors.length==0) {
					Alert.show("Saliendo de ColDes...");
				}
			}
			
			private function doRegister():void {
				var userReg:UserDataForm = new UserDataForm();
				
				PopUpManager.addPopUp(userReg, this, true);
				PopUpManager.centerPopUp(userReg);
			}
			
			public function submitRegister(user:User):void{
				(new UserService()).addUser(user, registerCallback);
			}
			
			private function registerCallback(newUser:String):void{
				if(newUser == ""){
					//User exist
					UtilPopUp.showMessagePopUP(resourceManager.getString('myResources','ERRORTITLE.REGISTER'),
										       resourceManager.getString('myResources','ERROR.REGISTER'));
				}else if (newUser == null){
					//Internal error
					UtilPopUp.showMessagePopUP(resourceManager.getString('myResources','ERRORTITLE.SERVER'),
										       resourceManager.getString('myResources','ERROR.SERVER'));
				}else{
					UtilPopUp.showMessagePopUP(resourceManager.getString('myResources','MESSAGETITLE.REGISTER'),
										       resourceManager.getString('myResources','MESSAGE.REGISTER'));
				}
			}
			
			/*************************************/
			/**       FUNCIONES DE SUBMENUS     **/
			/*************************************/
			
			private function openSubmenu(event:Event):void {
				var buttonClicked:Button=event.target as Button;
				buttonClicked.selected=true;
				if (buttonClicked == users) {
					rooms.selected=false;
					adminitration.selected=false;
					secondaryVS.selectedIndex=1;
				} else if (buttonClicked == rooms) {
					users.selected=false;
					adminitration.selected=false;
					secondaryVS.selectedIndex=2;
				} else if (buttonClicked == adminitration) {
					users.selected=false;
					rooms.selected=false;
					secondaryVS.selectedIndex=3;
				}else {
					buttonClicked.selected=false;
				}
			}
		]]>
	</mx:Script>
	<mx:Style source="ColDes.css"/>
	<mx:ViewStack height="100%" id="primaryVS" width="100%" creationPolicy="all">
		<mx:Canvas height="100%" width="100%"/>	
		<mx:Canvas id="loginFacade" width="100%" height="100%">
			
			<mx:HBox horizontalAlign="right" width="100%" paddingRight="5" paddingTop="5">
				<lang:LangConfig id="btnsLangConfigLogin" />
			</mx:HBox>
			<mx:Canvas horizontalCenter="0" verticalCenter="0">
				<mx:Image source="@Embed('/assets/images/fondologin.png')" horizontalCenter="0"/>
				<mx:Form id="loginForm" defaultButton="{btnAccess}" horizontalCenter="0" verticalCenter="16" paddingTop="10">
					<mx:FormItem label="{resourceManager.getString('myResources','LOGIN.USERNAME')}:" width="100%" labelStyleName="LabelLoginFormItem">
						<mx:TextInput id="txtUser"/>
					</mx:FormItem>
					<mx:FormItem label="{resourceManager.getString('myResources','LOGIN.PASSWORD')}:" width="100%" labelStyleName="LabelLoginFormItem">
						<mx:TextInput id="txtPassword" displayAsPassword="true"/>
					</mx:FormItem>
					<mx:HBox horizontalAlign="center" width="100%" paddingTop="10">
						<mx:Button id="btnRegister" label="{resourceManager.getString('myResources','LOGIN.REGISTER')}" click="doRegister()" width="80" height="30"/>
						<mx:Button id="btnAccess" label="{resourceManager.getString('myResources','LOGIN.ACCESS')}" click="doLogin()" width="80" height="30"/>
					</mx:HBox>
				</mx:Form>
			</mx:Canvas>
		</mx:Canvas>
		 
		<mx:Canvas id="mainWindow">
			<mx:VBox horizontalAlign="center" width="100%" height="100%">
				<mx:Canvas width="100%">	
					<mx:HBox horizontalAlign="left" width="100%" paddingRight="5" paddingTop="5">
						<mx:Button id="btnLogOut" height="20" icon="@Embed(source='assets/images/btnlogout.png')" label="{resourceManager.getString('myResources','MAINWINDOW.LOGOUT')}"/>
						<mx:Label text="{resourceManager.getString('myResources','LOGIN.USERNAME')}:" fontWeight="bold" textDecoration="underline"/>
						<mx:Label id="labelUsername" fontStyle="italic"/>
					</mx:HBox>
					<mx:HBox horizontalAlign="right" width="100%" paddingRight="5" paddingTop="5" horizontalGap="5">
						<lang:LangConfig id="btnsLangConfigMain" />
					</mx:HBox>
				</mx:Canvas>
				
				<flexlib:SuperTabNavigator width="100%" height="100%" id="tabs" closePolicy="{SuperTab.CLOSE_ROLLOVER}"
									   backgroundColor="#FFFFFF" dropEnabled="false" dragEnabled="false">
			
					<mx:VBox id="tabInit" height="100%" width="100%" label="{resourceManager.getString('myResources','MAINWINDOW.TITLE')}" horizontalAlign="center" verticalGap="30"
						 icon="@Embed('/assets/images/icos/home.gif')">
						<mx:Grid paddingTop="120" paddingBottom="20" horizontalGap="100" verticalGap="30" id="menu">
							<mx:GridRow width="100%">
								<mx:GridItem width="100%" horizontalAlign="center">
									<mx:Button label="{resourceManager.getString('myResources','MAINWINDOW.USERS')}"
											   styleName="HomeButton" id="users" click="openSubmenu(event)"
											   icon="@Embed(source='assets/images/user.png')"
											   width="300" height="100"/>
								</mx:GridItem>
								<mx:GridItem width="100%" horizontalAlign="center">
									<mx:Button label="{resourceManager.getString('myResources','MAINWINDOW.ROOMS')}" id="rooms" click="openSubmenu(event)"
											   styleName="HomeButton" width="300" height="100"
											   icon="@Embed(source='assets/images/room.png')"/>
								</mx:GridItem>
							</mx:GridRow>
						</mx:Grid>	
						<mx:Grid paddingBottom="20" horizontalGap="100" verticalGap="30" id="menuAdmin" includeInLayout="false" visible="false">
							<mx:GridRow width="100%" horizontalAlign="center">
								<mx:GridItem width="100%" horizontalAlign="center">
									<mx:Button label="{resourceManager.getString('myResources','MAINWINDOW.ADMINISTRATOR')}"
											   styleName="HomeButton" id="adminitration" click="openSubmenu(event)"
											   icon="@Embed(source='assets/images/config.png')"
											   width="300" height="100"/>
								</mx:GridItem>
							</mx:GridRow>
						</mx:Grid>
						<mx:HRule width="{menu.width * 1.1}" styleName="MainHRule" horizontalCenter=""/>
						<mx:ViewStack width="100%" height="100%" id="secondaryVS">
							<mx:HBox horizontalGap="20" horizontalAlign="center" width="100%">
								
							</mx:HBox>
							<mx:HBox width="100%" horizontalGap="20" horizontalAlign="center">
								<mx:Button styleName="HomeButtonSec" textAlign="center" width="250" height="60"
										   icon="@Embed(source='assets/images/mydata.png')"
										   label="{resourceManager.getString('myResources','MAINWINDOW.MYDATA')}"/>
							</mx:HBox>
							
							<mx:HBox width="100%" horizontalGap="20" horizontalAlign="center">
								<mx:Button styleName="HomeButtonSec" textAlign="center" width="250" height="60"
										   icon="@Embed(source='assets/images/myrooms.png')"
										   label="{resourceManager.getString('myResources','MAINWINDOW.MYROOMS')}"/>
								<mx:Button styleName="HomeButtonSec" textAlign="center" width="250" height="60"
										   icon="@Embed(source='assets/images/searchrooms.png')"
										   label="{resourceManager.getString('myResources','MAINWINDOW.SEARCHROOMS')}"/>
								<mx:Button styleName="HomeButtonSec" textAlign="center" width="250" height="60"
										   icon="@Embed(source='assets/images/addroom.png')"
										   label="{resourceManager.getString('myResources','MAINWINDOW.CREATEROOM')}"/>
							</mx:HBox>
							<mx:HBox width="100%" horizontalGap="20" horizontalAlign="center">
								<mx:Button styleName="HomeButtonSec" textAlign="center" width="250" height="60"
										   icon="@Embed(source='assets/images/usersconfig.png')"
										   label="{resourceManager.getString('myResources','MAINWINDOW.USERMANAGEMENT')}"/>
								<mx:Button styleName="HomeButtonSec" textAlign="center" width="250" height="60"
										   icon="@Embed(source='assets/images/roomconfig.png')"
										   label="{resourceManager.getString('myResources','MAINWINDOW.ROOMMANAGEMENT')}"/>
							</mx:HBox>
						</mx:ViewStack>
					</mx:VBox>
				</flexlib:SuperTabNavigator>
			</mx:VBox>
		</mx:Canvas>
	</mx:ViewStack>
	<mx:Array id="validators">
		<mx:StringValidator source="{txtUser}" property="text" trigger="{txtUser}" triggerEvent="focusOut"
							required="true" invalid="glowEffect.play([txtUser])"/>
		<mx:StringValidator source="{txtPassword}" property="text" trigger="{txtPassword}" triggerEvent="focusOut"
							required="true" invalid="glowEffect.play([txtPassword])"/>
	</mx:Array>
	<mx:Glow id="glowEffect" color="0xFF0000" duration="1000" alphaFrom="1.0" alphaTo="0"
			 blurXFrom="0.0" blurXTo="30.0" blurYFrom="0.0" blurYTo="30.0"/>
</mx:Application>
