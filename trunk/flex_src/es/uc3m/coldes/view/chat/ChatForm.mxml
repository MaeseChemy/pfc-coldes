<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns="es.uc3m.coldes.utils.ui.resize.*" 
	xmlns:mx="http://www.adobe.com/2006/mxml" 
	width="300" height="300" title="Chat">
	
	<mx:Script>
	<![CDATA[
		import mx.formatters.DateFormatter;
		import mx.messaging.channels.AMFChannel;
		import mx.messaging.ChannelSet;
		import mx.collections.ArrayCollection;
		import mx.messaging.messages.AsyncMessage;
		import mx.messaging.messages.IMessage;

		public function initDestination(destination:String):void{
			this.configConsumer(destination);
			this.configProducer(destination);
		}

		public function configConsumer(destination:String):void{
			consumer.destination = destination;
			
			var channelSet:ChannelSet = new ChannelSet();
			channelSet.addChannel(new AMFChannel("my-polling-amf", "http://pcjmbg:8400/ColDes/messagebroker/amfpolling"));
			
			consumer.channelSet = channelSet;
			consumer.subscribe();
		}
		
		public function configProducer(destination:String):void{
			producer.destination = destination;
			
			var channelSet:ChannelSet = new ChannelSet();
			channelSet.addChannel(new AMFChannel("my-polling-amf", "http://pcjmbg:8400/ColDes/messagebroker/amfpolling"));
			
			producer.channelSet = channelSet;
		}
		
		private function send():void{
			var message:IMessage = new AsyncMessage();
       		
       		if(msg.text != ""){
				message.body.username = parentApplication.userLoged.username;
				message.body.text = msg.text;
				
				log += "<u><b>"+message.body.username+"</b></u>:" + message.body.text + "\n";
				producer.send(message);
				msg.text = "";
       		}
		}
		private function messageHandler(message:IMessage):void{
			if(message.body.username != parentApplication.userLoged.username){ 
				log += "<u><b>"+message.body.username+"</b></u>:" + message.body.text + "\n";
			}
		}
		
		[Bindable]
		public var listOfUsers:ArrayCollection = new ArrayCollection();
		
		[Bindable]
		public var log:String = "";
	]]>
	
	</mx:Script>
	
	<mx:Consumer id="consumer" message="messageHandler(event.message)"/>
	<mx:Producer id="producer" />
	<mx:HBox width="100%" height="100%">
		<mx:DataGrid dataProvider="{listOfUsers}" height="100%" width="70" wordWrap="true" variableRowHeight="true">
			<mx:columns>
				<mx:DataGridColumn headerText="{resourceManager.getString('myResources','CHAT.USERS')}"/>
			</mx:columns>
		</mx:DataGrid>
		<mx:TextArea htmlText="{log}" width="100%" height="100%" editable="false" verticalScrollPolicy="auto"/>
	</mx:HBox>
	<mx:ControlBar>
		<mx:TextInput id="msg" width="100%" enter="send()"/>
		<mx:Button label="{resourceManager.getString('myResources','CHAT.SEND')}" click="send()"/>
	</mx:ControlBar>
</mx:TitleWindow>
